<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Resolution — EVENT-CLOSED</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: -apple-system, system-ui, Arial, sans-serif;
        margin: 24px;
        max-width: 980px;
      }
      h1 {
        margin: 0 0 6px 0;
      }
      .sub {
        margin: 0 0 18px 0;
        color: #666;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }
      .card {
        border: 1px solid #ddd;
        padding: 14px;
        border-radius: 12px;
      }
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid #ccc;
        font-size: 12px;
        background: #fff;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      }
      pre {
        background: #0b0b0b;
        color: #e8e8e8;
        padding: 12px;
        border-radius: 10px;
        overflow: auto;
        margin: 0;
      }
      a { color: inherit; }
      small { color: #666; }
      .ok { border-color: #5bb974; }
      .warn { border-color: #d7a400; }
      .bad { border-color: #d14; }
      button {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
      }
      button:hover { background: #f5f5f5; }
      select, input {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
    </style>
  </head>

  <body>
    <h1>Resolution <span class="badge mono">EVENT-CLOSED</span></h1>
    <p class="sub">
      Public witness surface (read-only). Canonical artifacts are served from <span class="mono">/ledger/…</span>.
    </p>

    <div class="card">
      <div class="row" style="align-items:center; justify-content:space-between;">
        <div>
          <div><b>Motion:</b> <span class="badge mono">RESOLUTION</span></div>
          <div style="margin-top:6px;"><b>Event state:</b> <span class="badge mono">EVENT-CLOSED</span></div>
        </div>
        <div class="row" style="margin:0;">
          <button onclick="refreshAll()">REFRESH</button>
        </div>
      </div>

      <div style="margin-top:10px;">
        <small>
          Entry point:
          <a class="mono" href="/ledger/index.json">/ledger/index.json</a>
        </small>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h3 style="margin-top:0;">Event</h3>
      <div class="row" style="align-items:center;">
        <label>
          <small>Choose event</small><br />
          <select id="eventSelect" onchange="loadSelectedEvent()"></select>
        </label>
        <label>
          <small>Latest version</small><br />
          <input id="latestVersion" class="mono" readonly />
        </label>
      </div>

      <div style="margin-top:10px;">
        <div><b>Decision URL:</b> <a id="decisionUrl" class="mono" href="#">—</a></div>
        <div style="margin-top:6px;"><b>Declaration URL:</b> <a id="declUrl" class="mono" href="#">—</a></div>
      </div>

      <div style="margin-top:10px;">
        <div><b>Integrity:</b> <span id="integrity" class="badge mono warn">not checked</span></div>
        <small>
          Integrity check compares <span class="mono">decision.declaration_hash_sha256</span> with the computed SHA-256 of
          <span class="mono">reality_declaration.json</span>.
        </small>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h3 style="margin-top:0;">Decision (proof_of_reality)</h3>
      <pre id="decisionView">Loading…</pre>
    </div>

    <div class="card" style="margin-top:14px;">
      <h3 style="margin-top:0;">Reality Declaration</h3>
      <pre id="declView">Loading…</pre>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      function joinUrl(base, rel) {
        // rel can be "./x.json" or "/ledger/..."
        if (!rel) return null;
        if (rel.startsWith("http://") || rel.startsWith("https://")) return rel;
        if (rel.startsWith("/")) return rel;
        // base like "/ledger/events/za-extra-kraj/2026-.../"
        return base.replace(/\/+$/, "") + "/" + rel.replace(/^\.?\//, "");
      }

      async function fetchJson(url) {
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error(`${url} → ${r.status}`);
        return await r.json();
      }

      async function fetchText(url) {
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error(`${url} → ${r.status}`);
        return await r.text();
      }

      async function sha256Hex(text) {
        const enc = new TextEncoder();
        const bytes = enc.encode(text);
        const digest = await crypto.subtle.digest("SHA-256", bytes);
        return Array.from(new Uint8Array(digest))
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      }

      function setIntegrity(state, msg) {
        const el = $("integrity");
        el.textContent = msg;
        el.classList.remove("ok", "warn", "bad");
        el.classList.add(state);
      }

      async function bootstrapEvents() {
        // Load /ledger/index.json (catalog)
        const index = await fetchJson("/ledger/index.json");

        const events = Array.isArray(index.events) ? index.events : [];
        const select = $("eventSelect");
        select.innerHTML = "";

        if (events.length === 0) {
          select.innerHTML = `<option value="">(no events in /ledger/index.json)</option>`;
          return;
        }

        for (const e of events) {
          const opt = document.createElement("option");
          opt.value = e.event_id;
          opt.textContent = `${e.event_id} — ${e.event || ""}`.trim();
          select.appendChild(opt);
        }

        // Auto-load first event
        await loadSelectedEvent();
      }

      async function loadSelectedEvent() {
        try {
          setIntegrity("warn", "loading…");

          const eventId = $("eventSelect").value;
          if (!eventId) return;

          // latest pointer
          const latestPath = `/ledger/events/${eventId}/latest.json`;
          const latest = await fetchJson(latestPath);

          $("latestVersion").value = latest.latest_version || "";

          // decision path is relative to /ledger/events/<id>/
          const eventBase = `/ledger/events/${eventId}`;
          const decisionUrl = joinUrl(eventBase, latest.latest_decision);

          $("decisionUrl").href = decisionUrl;
          $("decisionUrl").textContent = decisionUrl;

          const decision = await fetchJson(decisionUrl);
          $("decisionView").textContent = JSON.stringify(decision, null, 2);

          // declaration path is relative to decision folder
          const decisionFolder = decisionUrl.replace(/\/[^\/]+$/, ""); // strip filename
          const declRel = decision?.artifacts?.reality_declaration_json || "./reality_declaration.json";
          const declUrl = joinUrl(decisionFolder, declRel);

          $("declUrl").href = declUrl;
          $("declUrl").textContent = declUrl;

          // try to fetch declaration JSON as text (for hashing), then also pretty-print
          const declText = await fetchText(declUrl);
          let declJson = null;
          try { declJson = JSON.parse(declText); } catch (_) {}
          $("declView").textContent = declJson ? JSON.stringify(declJson, null, 2) : declText;

          // integrity check
          const computed = await sha256Hex(declText);
          const expected = decision.declaration_hash_sha256 || "";

          if (!expected) {
            setIntegrity("warn", "no expected hash in decision");
          } else if (computed.toLowerCase() === expected.toLowerCase()) {
            setIntegrity("ok", "hash verified ✓");
          } else {
            setIntegrity("bad", `hash mismatch ✗ (computed ${computed.slice(0, 12)}…)`);
          }
        } catch (err) {
          $("decisionView").textContent = String(err);
          $("declView").textContent = "—";
          setIntegrity("bad", "error");
        }
      }

      async function refreshAll() {
        await loadSelectedEvent();
      }

      // Boot
      bootstrapEvents();
    </script>
  </body>
</html>
