<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Resolution — Witness</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Witness declaration (machine friendly) -->
    <link rel="canonical" href="https://22.limited/" />
    <link rel="alternate" type="application/json" title="witness" href="/witness.json" />
    <link rel="alternate" type="application/json" title="third.site root" href="https://third.site/root.json" />
    <link rel="alternate" type="application/json" title="instances index" href="https://third.site/instances/index.json" />

    <style>
      body {
        font-family: -apple-system, system-ui, Arial, sans-serif;
        margin: 24px;
        max-width: 980px;
      }
      h1 { margin: 0 0 6px 0; }
      .sub { margin: 0 0 18px 0; color: #666; }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }
      .card {
        border: 1px solid #ddd;
        padding: 14px;
        border-radius: 12px;
      }
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid #ccc;
        font-size: 12px;
        background: #fff;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      }
      pre {
        background: #0b0b0b;
        color: #e8e8e8;
        padding: 12px;
        border-radius: 10px;
        overflow: auto;
        margin: 0;
      }
      a { color: inherit; }
      small { color: #666; }
      .ok { border-color: #5bb974; }
      .warn { border-color: #d7a400; }
      .bad { border-color: #d14; }
      button {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
      }
      button:hover { background: #f5f5f5; }
      select, input {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
    </style>
  </head>

  <body>
    <h1>Resolution <span class="badge mono">WITNESS</span></h1>
    <p class="sub">
      Public witness surface (read-only). Instances are served from
      <a class="mono" href="https://third.site/instances/index.json" target="_blank" rel="noopener">third.site/instances</a>.
    </p>

    <div class="card">
      <div class="row" style="align-items:center; justify-content:space-between;">
        <div>
          <div><b>Motion:</b> <span class="badge mono">RESOLUTION</span></div>
          <div style="margin-top:6px;"><b>Role:</b> <span class="badge mono">DERIVATIVE_WITNESS</span></div>
        </div>
        <div class="row" style="margin:0;">
          <button onclick="refreshAll()">REFRESH</button>
        </div>
      </div>

      <div style="margin-top:10px;">
        <small>
          Root:
          <a class="mono" href="https://third.site/root.json" target="_blank" rel="noopener">https://third.site/root.json</a>
          &nbsp;•&nbsp;
          Entry:
          <a class="mono" href="https://third.site/instances/index.json" target="_blank" rel="noopener">instances/index.json</a>
        </small>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h3 style="margin-top:0;">Instance</h3>
      <div class="row" style="align-items:center;">
        <label>
          <small>Choose instance (event • timestamp)</small><br />
          <select id="instanceSelect" onchange="loadSelectedInstance()"></select>
        </label>
        <label>
          <small>Timestamp</small><br />
          <input id="ts" class="mono" readonly />
        </label>
      </div>

      <div style="margin-top:10px;">
        <div><b>Decision URL:</b> <a id="decisionUrl" class="mono" href="#">—</a></div>
        <div style="margin-top:6px;"><b>Declaration URL:</b> <a id="declUrl" class="mono" href="#">—</a></div>
      </div>

      <div style="margin-top:10px;">
        <div><b>Integrity:</b> <span id="integrity" class="badge mono warn">not checked</span></div>
        <small>
          Integrity check compares <span class="mono">decision.declaration_hash_sha256</span> with the computed SHA-256 of
          <span class="mono">reality_declaration.json</span>.
        </small>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h3 style="margin-top:0;">Decision (proof_of_reality)</h3>
      <pre id="decisionView">Loading…</pre>
    </div>

    <div class="card" style="margin-top:14px;">
      <h3 style="margin-top:0;">Reality Declaration</h3>
      <pre id="declView">Loading…</pre>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      const ROOT = "https://third.site";
      const INSTANCES_INDEX = `${ROOT}/instances/index.json`;

      function abs(urlOrPath) {
        if (!urlOrPath) return null;
        if (urlOrPath.startsWith("http://") || urlOrPath.startsWith("https://")) return urlOrPath;
        if (urlOrPath.startsWith("/")) return ROOT + urlOrPath;
        return ROOT + "/" + urlOrPath.replace(/^\.?\//, "");
      }

      async function fetchJson(url) {
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error(`${url} → ${r.status}`);
        return await r.json();
      }

      async function fetchText(url) {
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error(`${url} → ${r.status}`);
        return await r.text();
      }

      async function sha256Hex(text) {
        const enc = new TextEncoder();
        const bytes = enc.encode(text);
        const digest = await crypto.subtle.digest("SHA-256", bytes);
        return Array.from(new Uint8Array(digest))
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      }

      function setIntegrity(state, msg) {
        const el = $("integrity");
        el.textContent = msg;
        el.classList.remove("ok", "warn", "bad");
        el.classList.add(state);
      }

      // We index *instances*, not "events + latest.json".
      // Your third.site schema already gives us the exact URLs.
      let INSTANCES = [];

      function instanceLabel(i) {
        const ev = i.event_id || "unknown";
        const ts = i.timestamp_utc || i.timestamp || "unknown-time";
        return `${ev} • ${ts}`;
      }

      async function bootstrapInstances() {
        const idx = await fetchJson(INSTANCES_INDEX);
        const list = Array.isArray(idx.instances) ? idx.instances : [];

        // Sort newest first by timestamp_utc when possible
        list.sort((a, b) => String(b.timestamp_utc || "").localeCompare(String(a.timestamp_utc || "")));

        INSTANCES = list;

        const select = $("instanceSelect");
        select.innerHTML = "";

        if (INSTANCES.length === 0) {
          select.innerHTML = `<option value="">(no instances in third.site/instances/index.json)</option>`;
          return;
        }

        for (let n = 0; n < INSTANCES.length; n++) {
          const i = INSTANCES[n];
          const opt = document.createElement("option");
          opt.value = String(n);
          opt.textContent = instanceLabel(i);
          select.appendChild(opt);
        }

        await loadSelectedInstance();
      }

      async function loadSelectedInstance() {
        try {
          setIntegrity("warn", "loading…");

          const ix = $("instanceSelect").value;
          if (ix === "") return;

          const i = INSTANCES[Number(ix)];
          const ts = i.timestamp_utc || "";
          $("ts").value = ts;

          const decisionUrl = abs(i.decision);
          const declUrl = abs(i.reality_declaration);

          $("decisionUrl").href = decisionUrl;
          $("decisionUrl").textContent = decisionUrl;

          $("declUrl").href = declUrl;
          $("declUrl").textContent = declUrl;

          const decision = await fetchJson(decisionUrl);
          $("decisionView").textContent = JSON.stringify(decision, null, 2);

          const declText = await fetchText(declUrl);
          let declJson = null;
          try { declJson = JSON.parse(declText); } catch (_) {}
          $("declView").textContent = declJson ? JSON.stringify(declJson, null, 2) : declText;

          const computed = await sha256Hex(declText);
          const expected = decision.declaration_hash_sha256 || "";

          if (!expected) {
            setIntegrity("warn", "no expected hash in decision");
          } else if (computed.toLowerCase() === expected.toLowerCase()) {
            setIntegrity("ok", "hash verified ✓");
          } else {
            setIntegrity("bad", `hash mismatch ✗ (computed ${computed.slice(0, 12)}…)`);
          }
        } catch (err) {
          $("decisionView").textContent = String(err);
          $("declView").textContent = "—";
          setIntegrity("bad", "error");
        }
      }

      async function refreshAll() {
        await bootstrapInstances();
      }

      bootstrapInstances();
    </script>
  </body>
</html>
